{% extends 'base.html' %}

{% block title %}Отчёты — Retail Monitor{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 mb-0">Отчёты</h1>
</div>

<!-- Stats Cards -->
<div class="row mb-4">
    <div class="col-md-4">
        <div class="card border-0 bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="text-white-50 small">Всего товаров</div>
                        <div class="h2 mb-0">{{ total_products }}</div>
                    </div>
                    <i class="bi bi-box-seam fs-1 opacity-50"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card border-0 bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="text-white-50 small">Наши товары</div>
                        <div class="h2 mb-0">{{ own_products }}</div>
                    </div>
                    <i class="bi bi-check-circle fs-1 opacity-50"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card border-0 bg-secondary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="text-white-50 small">Конкуренты</div>
                        <div class="h2 mb-0">{{ competitor_products }}</div>
                    </div>
                    <i class="bi bi-people fs-1 opacity-50"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Export Form -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="card-title mb-0"><i class="bi bi-sliders me-2"></i>Параметры экспорта</h5>
    </div>
    <div class="card-body">
        <form id="exportForm" method="get" action="{% url 'reports:export' %}">
            <div class="row g-3">
                <div class="col-md-3">
                    <label class="form-label">Период с</label>
                    <input type="date" name="period_from" class="form-control" value="{{ period_from }}">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Период по</label>
                    <input type="date" name="period_to" class="form-control" value="{{ period_to }}">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Тип товаров</label>
                    <select name="is_own" class="form-select">
                        <option value="">Все товары</option>
                        <option value="1">Только наши</option>
                        <option value="0">Только конкуренты</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Ретейлер</label>
                    <select name="retailer" class="form-select">
                        <option value="">Все ретейлеры</option>
                        {% for retailer in retailers %}
                        <option value="{{ retailer.pk }}">{{ retailer.name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Report Types -->
<div class="row">
    <!-- Full Report -->
    <div class="col-md-6 mb-4">
        <div class="card h-100">
            <div class="card-body">
                <div class="d-flex align-items-start">
                    <div class="bg-primary bg-opacity-10 rounded p-3 me-3">
                        <i class="bi bi-file-earmark-spreadsheet text-primary fs-3"></i>
                    </div>
                    <div class="flex-grow-1">
                        <h5 class="card-title">Полный отчёт</h5>
                        <p class="card-text text-muted">
                            Excel файл с тремя листами: матрица цен, матрица отзывов и AI-выводы по каждому товару.
                        </p>
                        <ul class="small text-muted mb-3">
                            <li>Лист "Цены" — товары x месяцы x ретейлеры</li>
                            <li>Лист "Отзывы" — рейтинг, кол-во отзывов, негативные</li>
                            <li>Лист "Выводы" — рекомендации на основе AI-анализа</li>
                        </ul>
                        <button type="button" class="btn btn-primary export-btn" data-type="full">
                            <i class="bi bi-download me-1"></i> Скачать полный отчёт
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Price Matrix -->
    <div class="col-md-6 mb-4">
        <div class="card h-100">
            <div class="card-body">
                <div class="d-flex align-items-start">
                    <div class="bg-success bg-opacity-10 rounded p-3 me-3">
                        <i class="bi bi-currency-exchange text-success fs-3"></i>
                    </div>
                    <div class="flex-grow-1">
                        <h5 class="card-title">Матрица цен</h5>
                        <p class="card-text text-muted">
                            Таблица цен по всем товарам, месяцам и ретейлерам. Удобно для анализа динамики цен.
                        </p>
                        <ul class="small text-muted mb-3">
                            <li>Строки — товары (наши и конкуренты)</li>
                            <li>Столбцы — месяцы x ретейлеры</li>
                            <li>Значения — финальная цена с учётом скидок</li>
                        </ul>
                        <button type="button" class="btn btn-outline-success export-btn" data-type="prices">
                            <i class="bi bi-download me-1"></i> Скачать матрицу цен
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Reviews Matrix -->
    <div class="col-md-6 mb-4">
        <div class="card h-100">
            <div class="card-body">
                <div class="d-flex align-items-start">
                    <div class="bg-warning bg-opacity-10 rounded p-3 me-3">
                        <i class="bi bi-star-half text-warning fs-3"></i>
                    </div>
                    <div class="flex-grow-1">
                        <h5 class="card-title">Матрица отзывов</h5>
                        <p class="card-text text-muted">
                            Сводная информация по отзывам: средний рейтинг, количество отзывов и негативных отзывов.
                        </p>
                        <ul class="small text-muted mb-3">
                            <li>Строки — товары (наши и конкуренты)</li>
                            <li>Столбцы — месяцы (рейтинг, всего, негативных)</li>
                            <li>Подсветка негативных значений</li>
                        </ul>
                        <button type="button" class="btn btn-outline-warning export-btn" data-type="reviews">
                            <i class="bi bi-download me-1"></i> Скачать матрицу отзывов
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Insights -->
    <div class="col-md-6 mb-4">
        <div class="card h-100">
            <div class="card-body">
                <div class="d-flex align-items-start">
                    <div class="bg-info bg-opacity-10 rounded p-3 me-3">
                        <i class="bi bi-lightbulb text-info fs-3"></i>
                    </div>
                    <div class="flex-grow-1">
                        <h5 class="card-title">AI-выводы</h5>
                        <p class="card-text text-muted">
                            Рекомендации на основе AI-анализа отзывов: что убрать, изменить в упаковке или вкусе.
                        </p>
                        <ul class="small text-muted mb-3">
                            <li>Что убрать из продукта</li>
                            <li>Рекомендации по упаковке и вкусу</li>
                            <li>Позитивные и негативные темы</li>
                        </ul>
                        <button type="button" class="btn btn-outline-info export-btn" data-type="insights">
                            <i class="bi bi-download me-1"></i> Скачать AI-выводы
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Info Alert -->
<div class="alert alert-info">
    <i class="bi bi-info-circle me-2"></i>
    <strong>Совет:</strong> Для получения AI-выводов сначала запустите анализ отзывов через
    <a href="{% url 'admin:index' %}">админку</a> или дождитесь автоматического ежемесячного анализа.
</div>
{% endblock %}

{% block extra_js %}
<script>
document.querySelectorAll('.export-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        const form = document.getElementById('exportForm');
        const formData = new FormData(form);

        // Add report type
        formData.set('type', this.dataset.type);

        // Build URL
        const params = new URLSearchParams(formData);
        window.location.href = form.action + '?' + params.toString();
    });
});
</script>
{% endblock %}
