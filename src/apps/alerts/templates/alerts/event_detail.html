{% extends 'base.html' %}

{% block title %}–°–æ–±—ã—Ç–∏–µ –æ–ø–æ–≤–µ—â–µ–Ω–∏—è ‚Äî Retail Monitor{% endblock %}

{% block content %}
<nav aria-label="breadcrumb" class="mb-3">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'alerts:rule_list' %}">–û–ø–æ–≤–µ—â–µ–Ω–∏—è</a></li>
        <li class="breadcrumb-item"><a href="{% url 'alerts:event_list' %}">–°–æ–±—ã—Ç–∏—è</a></li>
        <li class="breadcrumb-item active">–°–æ–±—ã—Ç–∏–µ</li>
    </ol>
</nav>

<div class="row">
    <div class="col-md-8">
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    {% if event.alert_rule.alert_type == 'price_increase' %}
                    <span class="badge bg-danger me-2">üìà</span>
                    {% elif event.alert_rule.alert_type == 'price_decrease' %}
                    <span class="badge bg-success me-2">üìâ</span>
                    {% elif event.alert_rule.alert_type == 'new_negative_review' %}
                    <span class="badge bg-warning text-dark me-2">üò°</span>
                    {% elif event.alert_rule.alert_type == 'out_of_stock' %}
                    <span class="badge bg-secondary me-2">‚ùå</span>
                    {% else %}
                    <span class="badge bg-info me-2">üîî</span>
                    {% endif %}
                    {{ event.alert_rule.get_alert_type_display }}
                </h5>
                <span class="text-muted">{{ event.triggered_at|date:"d.m.Y H:i:s" }}</span>
            </div>
            <div class="card-body">
                <h4>{{ event.listing.product.name }}</h4>
                <p class="text-muted mb-3">{{ event.listing.retailer.name }}</p>

                <div class="alert alert-secondary">
                    {{ event.message }}
                </div>

                {% if event.details %}
                <h6 class="mt-4">–î–µ—Ç–∞–ª–∏</h6>
                <table class="table table-sm">
                    <tbody>
                        {% if event.details.old_price %}
                        <tr>
                            <th>–°—Ç–∞—Ä–∞—è —Ü–µ–Ω–∞</th>
                            <td>{{ event.details.old_price }} ‚ÇΩ</td>
                        </tr>
                        {% endif %}
                        {% if event.details.new_price %}
                        <tr>
                            <th>–ù–æ–≤–∞—è —Ü–µ–Ω–∞</th>
                            <td>{{ event.details.new_price }} ‚ÇΩ</td>
                        </tr>
                        {% endif %}
                        {% if event.details.pct_change %}
                        <tr>
                            <th>–ò–∑–º–µ–Ω–µ–Ω–∏–µ</th>
                            <td>{% if event.details.pct_change > 0 %}+{% endif %}{{ event.details.pct_change|floatformat:1 }}%</td>
                        </tr>
                        {% endif %}
                        {% if event.details.rating %}
                        <tr>
                            <th>–†–µ–π—Ç–∏–Ω–≥ –æ—Ç–∑—ã–≤–∞</th>
                            <td>
                                {% for i in "12345" %}
                                    {% if forloop.counter <= event.details.rating %}
                                    <i class="bi bi-star-fill text-warning"></i>
                                    {% else %}
                                    <i class="bi bi-star text-muted"></i>
                                    {% endif %}
                                {% endfor %}
                            </td>
                        </tr>
                        {% endif %}
                        {% if event.details.author %}
                        <tr>
                            <th>–ê–≤—Ç–æ—Ä</th>
                            <td>{{ event.details.author }}</td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>

                {% if event.details.review_text %}
                <h6 class="mt-4">–¢–µ–∫—Å—Ç –æ—Ç–∑—ã–≤–∞</h6>
                <blockquote class="blockquote">
                    <p class="small">{{ event.details.review_text }}</p>
                </blockquote>
                {% endif %}

                {% if event.details.pros %}
                <div class="alert alert-success">
                    <strong>–î–æ—Å—Ç–æ–∏–Ω—Å—Ç–≤–∞:</strong> {{ event.details.pros }}
                </div>
                {% endif %}
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <!-- Delivery Status -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">–°—Ç–∞—Ç—É—Å –¥–æ—Å—Ç–∞–≤–∫–∏</h5>
            </div>
            <div class="card-body">
                {% if event.is_delivered %}
                <div class="text-center py-3">
                    <i class="bi bi-check-circle-fill text-success fs-1"></i>
                    <p class="mt-2 mb-0 text-success">–î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ</p>
                    {% if event.delivered_at %}
                    <small class="text-muted">{{ event.delivered_at|date:"d.m.Y H:i:s" }}</small>
                    {% endif %}
                </div>
                {% elif event.delivery_error %}
                <div class="text-center py-3">
                    <i class="bi bi-x-circle-fill text-danger fs-1"></i>
                    <p class="mt-2 mb-0 text-danger">–û—à–∏–±–∫–∞ –¥–æ—Å—Ç–∞–≤–∫–∏</p>
                    <small class="text-muted">{{ event.delivery_error }}</small>
                </div>
                {% else %}
                <div class="text-center py-3">
                    <i class="bi bi-clock-fill text-warning fs-1"></i>
                    <p class="mt-2 mb-0 text-warning">–û–∂–∏–¥–∞–µ—Ç –¥–æ—Å—Ç–∞–≤–∫–∏</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Related Info -->
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h5>
            </div>
            <div class="card-body">
                <dl class="mb-0">
                    <dt>–ü—Ä–∞–≤–∏–ª–æ</dt>
                    <dd>
                        <a href="{% url 'alerts:rule_detail' pk=event.alert_rule.pk %}">
                            {{ event.alert_rule.name }}
                        </a>
                    </dd>

                    <dt>–¢–æ–≤–∞—Ä</dt>
                    <dd>
                        <a href="{% url 'products:detail' pk=event.listing.product.pk %}">
                            {{ event.listing.product.name }}
                        </a>
                    </dd>

                    <dt>–†–µ—Ç–µ–π–ª–µ—Ä</dt>
                    <dd>{{ event.listing.retailer.name }}</dd>

                    {% if event.snapshot %}
                    <dt>–°–Ω–∏–º–æ–∫ —Ü–µ–Ω—ã</dt>
                    <dd>
                        {{ event.snapshot.scraped_at|date:"d.m.Y H:i" }}
                        {% if event.snapshot.price_final %}
                        ‚Äî {{ event.snapshot.price_final }} ‚ÇΩ
                        {% endif %}
                    </dd>
                    {% endif %}

                    <dt>ID —Å–æ–±—ã—Ç–∏—è</dt>
                    <dd><code class="small">{{ event.pk }}</code></dd>
                </dl>
            </div>
        </div>
    </div>
</div>
{% endblock %}
